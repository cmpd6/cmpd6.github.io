---
title: "CMPD6 abstracts"
format:
  pdf:
    toc: true
    number-sections: false
    colorlinks: true
    geometry:
      - top=20mm
      - bottom=20mm
      - left=20mm
      - right=20mm
      - heightrounded
execute:
  echo: false
---


```{r}
#| echo: false
#| message: false
#| results: 'hide'
# Process list of abstracts
library(yaml)
library(dplyr)
library(stringr)
library(countrycode)

# Process yaml header
# The markdown files used have just a yaml header; the markdown part
# often causes read_yml to crash. So we process only the header
process_yml_header = function(fqfn) {
  yaml_part = NULL
  con = file(fqfn, "r")
  line = readLines(con, n = 1)
  if (line == "---") {
    in_yaml = TRUE
    while ( in_yaml ) {
      line = readLines(con, n = 1)
      if ( length(line) == 0 ) {
        break
      } else if (line == "---") {
        in_yaml = FALSE
      } else {
        yaml_part = paste0(yaml_part, line, "\n")
      }
    }
  }
  close(con)
  yaml_fields = read_yaml(text = yaml_part)
  return(yaml_fields)
}
# Make stuff LaTeX compatible (e.g., & to \&)
make_LaTeX_friendly = function(ch) {
  ch = gsub("&", "\\&", ch)
  ch = gsub("/assets/images/", "../assets/images/", ch)
  return(ch)
}
# Are we testing (i.e., exporting to the working directory) or in production?
TESTING = TRUE
## PARTICIPANTS
# Get list of participants from csv file
participants_csv = read.csv("CMPD6-all-participants.csv")
participants_csv$email = tolower(participants_csv$email)
## ABSTRACTS
# Get list of abstracts from csv file
abstracts_csv = read.csv("CMPD6-abstracts.csv")
abstracts_csv$email = tolower(abstracts_csv$email)
# A bit of cleaning of the file
abstracts_csv$first_name = str_trim(str_to_title(abstracts_csv$first_name))
abstracts_csv$last_name = str_trim(str_to_title(abstracts_csv$last_name))
abstracts_csv$email = str_trim(tolower(abstracts_csv$email))
abstracts_csv$full_name = sprintf("%s %s", 
                                 abstracts_csv$first_name,
                                 abstracts_csv$last_name)
## Merge tables
all_info = merge(x = participants_csv, y = abstracts_csv,
                 by.x = "email", by.y = "email", 
                 all.y = TRUE)
colnames(all_info)[which(colnames(all_info) == "first_name.y")] =
  "first_name"
colnames(all_info)[which(colnames(all_info) == "last_name.y")] = 
  "last_name"
# Rewrite abstracts table
abstracts = all_info %>%
  arrange(last_name, first_name)
# Keep only talks
idx_talks = which(abstracts$plenary.x == TRUE)
idx_talks = union(idx_talks, which(abstracts$plenary.y == TRUE))
idx_talks = 
  union(idx_talks, which(nchar(abstracts$minisymposium) > 0))
idx_talks = 
  union(idx_talks, which(nchar(abstracts$contributed) > 0))
idx_talks = sort(idx_talks)
abstracts = abstracts[idx_talks,]
```


\vskip\medskipamount
\leaders\vrule width \textwidth\vskip0.4pt
\vskip\medskipamount
\nointerlineskip
\newpage

```{r}
#| echo: false
#| message: false
#| results: 'asis'
###
### GENERATE ABSTRACT LIST
###
for (i in 1:dim(abstracts)[1]) {
  cat("\n## ", abstracts$full_name[i], " - ",
      str_trim(abstracts$talk_title[i]),
      "\n")
  cat(abstracts$full_name[i], "\n\n")
  if (!is.na(abstracts$department[i])) {
    if (nchar(abstracts$department[i])>0) {
      cat(paste0(abstracts$department[i], "\n\n"))
    }
  }
  cat(paste0(abstracts$institution.y[i], ", ",
             abstracts$institution_country[i]), "\n\n")
  # cat("## ", str_trim(abstracts$talk_title[i]))
  if (abstracts$plenary.y[i] == "P") {
    cat("\n\n#### Plenary presentation")
  } else if (nchar(abstracts$minisymposium[i])>0) {
    cat("\n\n#### Part of minisymposium ")
    # This is an MS lecture, save which MS it is
    name_ms = tolower(abstracts$name_ms[i])
    name_ms = str_trim(gsub("-\t", " ", name_ms))
    cat(name_ms)
    cat(abstracts$minisymposium[i])
  } else if (nchar(abstracts$contributed[i])>0) {
    cat("\n\n#### Contributed talk")
  }
  if (nchar(abstracts$talk_abstract[i])>0) {
    cat("\n\n", make_LaTeX_friendly(abstracts$talk_abstract[i]))
  }
  cat("\n")
  cat("\\vskip\\medskipamount\n
  \\leaders\\vrule width \\textwidth\\vskip0.4pt\n
  \\vskip\\medskipamount\n
  \\nointerlineskip\n\n")
}
```
